### Install MySQL on Mac

brew update
brew install mysql

brew services start mysql

brew services list
mysql -u root

ALTER USER 'root'@'localhost' IDENTIFIED WITH caching_sha2_password BY 'legit756';
FLUSH PRIVILEGES;

CREATE USER 'trustgate'@'localhost' IDENTIFIED BY 'trustgate';
GRANT ALL PRIVILEGES ON trustgate.* TO 'trustgate'@'localhost';
FLUSH PRIVILEGES;

### Database 
CREATE TABLE trustgate.users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(100) UNIQUE NOT NULL,
    email VARCHAR(150) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    status ENUM('ACTIVE', 'DISABLED') DEFAULT 'ACTIVE',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

CREATE TABLE trustgate.user_profiles (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    full_name VARCHAR(200),
    picture_url VARCHAR(500),
    email_verified BOOLEAN DEFAULT FALSE,
    locale VARCHAR(20),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

CREATE TABLE trustgate.oauth_clients (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    client_id VARCHAR(100) UNIQUE NOT NULL,
    client_secret VARCHAR(255) NOT NULL,
    name VARCHAR(200),
    redirect_uris TEXT NOT NULL, -- store as JSON or comma separated
    scopes TEXT NOT NULL,
    grant_types TEXT NOT NULL,
    access_token_ttl INT DEFAULT 3600,
    refresh_token_ttl INT DEFAULT 2592000,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE trustgate.authorizations (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    client_id VARCHAR(100) NOT NULL,
    scopes TEXT NOT NULL,
    approved_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (client_id) REFERENCES oauth_clients(client_id)
);

CREATE TABLE trustgate.auth_codes (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    code VARCHAR(255) UNIQUE NOT NULL,
    user_id BIGINT NOT NULL,
    client_id VARCHAR(100) NOT NULL,
    redirect_uri VARCHAR(500),
    scopes TEXT NOT NULL,
    code_challenge VARCHAR(255),
    expires_at TIMESTAMP NOT NULL,
    used BOOLEAN DEFAULT FALSE,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (client_id) REFERENCES oauth_clients(client_id)
);

CREATE TABLE trustgate.tokens (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    client_id VARCHAR(100) NOT NULL,
    type ENUM('ACCESS', 'REFRESH') NOT NULL,
    value_hash VARCHAR(255) NOT NULL,
    jti VARCHAR(100) UNIQUE NOT NULL, -- JWT ID for tracking
    scopes TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP NOT NULL,
    revoked BOOLEAN DEFAULT FALSE,
    parent_token_id BIGINT NULL,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (client_id) REFERENCES oauth_clients(client_id),
    FOREIGN KEY (parent_token_id) REFERENCES tokens(id) ON DELETE SET NULL
);

CREATE TABLE trustgate.jwk_keys (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    kid VARCHAR(100) UNIQUE NOT NULL,
    public_pem TEXT NOT NULL,
    private_pem_encrypted TEXT NOT NULL,
    alg VARCHAR(10) DEFAULT 'RS256',
    `use` VARCHAR(10) DEFAULT 'sig',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    retired_at TIMESTAMP NULL
);









